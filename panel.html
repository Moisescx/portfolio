<!DOCTYPE html>
<html>

<head>
    <title>Panel Admin</title>
    <style>
        body {
            font-family: Arial;
            background: #f5f5f5;
            text-align: center;
            padding: 50px;
        }

        #loginForm {
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            margin: 0 auto;
        }

        #uploadForm {
            display: none;
            /* Oculto hasta login */
            background: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 400px;
            margin: 20px auto;
        }

        #uploadForm input,
        #uploadForm button {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 8px;
        }

        #errorMsg {
            color: red;
            display: none;
        }

        .loading {
            opacity: 0.7;
            cursor: wait;
        }
    </style>
</head>

<body>

    <!-- Formulario de Login -->
    <div id="loginForm">
        <h2>Acceso al Panel</h2>
        <input type="password" id="passwordInput" placeholder="Contraseña">
        <button onclick="login()">Entrar</button>
        <p id="errorMsg">Contraseña incorrecta</p>
    </div>

    <!-- Formulario de Subida -->
    <form id="uploadForm">
        <h3>Subir nueva imagen</h3>
        <input type="file" id="imageInput" accept="image/jpeg, image/png, image/webp" required>
        <input type="text" id="imageTitle" placeholder="Título de la imagen" required>
        <button type="submit" id="submitBtn">Subir</button>
        <p id="uploadStatus"></p>
    </form>

    <script>
        // Contraseña
        const CONTRASEÑA = "4&zW4~/~G}Kfpd05MtD8'rEIEnn_";

// Login
async function login() {
    const input = document.getElementById("passwordInput").value;

    try {
        const response = await fetch('/.netlify/functions/auth', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ password: input }),
        });

        if (!response.ok) {
            throw new Error("Contraseña incorrecta");
        }

        const { token } = await response.json();
        localStorage.setItem("authToken", token); // Guarda el token en localStorage
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("uploadForm").style.display = "block";
    } catch (error) {
        document.getElementById("errorMsg").textContent = error.message;
        document.getElementById("errorMsg").style.display = "block";
    }
}

// Verificar autenticación al cargar la página
document.addEventListener("DOMContentLoaded", () => {
    const token = localStorage.getItem("authToken");
    if (token) {
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("uploadForm").style.display = "block";
    }
});

// Manejo del formulario de subida
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const file = document.getElementById('imageInput').files[0];
    const title = document.getElementById('imageTitle').value;
    const submitBtn = document.querySelector('#uploadForm button[type="submit"]');
    const statusMsg = document.getElementById('uploadStatus');
    const token = localStorage.getItem("authToken");

    if (!token) {
        statusMsg.textContent = "⚠️ No estás autenticado.";
        statusMsg.style.color = "red";
        return;
    }

    try {
        submitBtn.disabled = true;
        submitBtn.textContent = "Subiendo...";
        statusMsg.textContent = "Procesando imagen...";
        statusMsg.style.color = "blue";

        const base64File = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = (error) => reject(new Error("No se pudo leer el archivo"));
            reader.readAsDataURL(file);
        });

        const filename = `img-${Date.now()}-${Math.random().toString(36).substring(2)}.${file.name.split('.').pop().toLowerCase()}`;
        const response = await fetch('/.netlify/functions/upload', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
            },
            body: JSON.stringify({
                file: base64File,
                filename,
                title,
            }),
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || "Error en el servidor");
        }

        statusMsg.textContent = "✅ ¡Imagen subida correctamente!";
        statusMsg.style.color = "green";
    } catch (error) {
        console.error("Error:", error);
        statusMsg.textContent = `❌ Error: ${error.message}`;
        statusMsg.style.color = "red";
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "Subir";
    }
});    </script>
</body>

</html>